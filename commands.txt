## Commands
This section lists command(s) run by djerbaReportGenerator workflow

* Running djerbaReportGenerator

djerbaReportGenerator creates clinical and RUO djerba reports by generating intermediate INI files and running Djerba. 


Retrieve callability from mutectcallability qc-etl cache if assay type is WGTS or WGS

```
    set -euo pipefail
    LimsId="~{sep=" " LimsId}"
    python3 $DJERBAREPORTER_ROOT/share/callSearch.py --lims-id $LimsId --gsiqcetl-dir ~{activeCache} --gsiqcetl-dir ~{archivalCache}
```

Retrieve median_insert_size and coverage_deduplicated from bamqc4merged or hsmetrics qc-etl cache depending on assay type

```
    set -euo pipefail
    LimsId="~{sep=" " LimsId}"
    python3 $DJERBAREPORTER_ROOT/share/covSearch.py --lims-id $LimsId --gsiqcetl-dir ~{activeCache} --gsiqcetl-dir ~{archivalCache} --assay ~{assay}
```

Create the intermediate INI file 

```
    set -euo pipefail
        python3 $DJERBAREPORTER_ROOT/share/createINI.py \
            --project "~{project}" \
            --study "~{study}" \
            --donor "~{donor}" \
            --report_id "~{reportId}" \
            --assay "~{assay}" \
            --patient_study_id "~{patientStudyId}" \
            --attributes "~{attributes}" \
            --template_dir "~{template_dir}" \
            ~{createArgs}
```

Create sample_info.json and provenanve_subset.tsv.gz file if assay type is WGS or WGTS

```
cat <<EOF > sample_info.json
        {
        "project": "~{project}",
        "donor": "~{donor}",
        "patientStudyId": "~{patientStudyId}",
        "tumourId": "~{tumourId}",
        "normalId": "~{normalId}",
        "sampleNameTumour": "~{sampleNameTumour}",
        "sampleNameNormal": "~{sampleNameNormal}",
        "sampleNameAux": "~{sampleNameAux}"
        }
    EOF

cat <<EOF > provenance_subset.tsv.gz
EOF
```

Run Djerba

```
   set -euo pipefail
    mkdir -p ~{Prefix}

    if [[ "~{assay}" == "WGTS" || "~{assay}" == "WGS" ]]; then    
        if [[ -n "~{sampleInfo}" ]]; then        
            rsync -aL "~{sampleInfo}" "~{Prefix}/"    
        fi    
        if [[ -n "~{provenanceSubset}" ]]; then        
            rsync -aL "~{provenanceSubset}" "~{Prefix}/"    
        fi
    fi
        
    export ONCOKB_TOKEN=/.mounts/labs/gsiprojects/gsi/CGI/resources/.oncokb_api_token

    $DJERBA_ROOT/bin/djerba.py report \
        -i ~{iniFile} \
        -o ~{Prefix} \
        --pdf \
        --no-archive 
        
    #Run blurbomatic
    if [[ "~{attributes}" == "clinical" && ( "~{assay}" == "WGTS" || "~{assay}" == "WGS" ) ]]; then
        python3 $DJERBAREPORTER_ROOT/share/blurbomatic.py < ~{Prefix}/~{reportId}_report.json > ~{Prefix}/results_summary.txt
        $DJERBA_ROOT/bin/djerba.py update -j ~{Prefix}/~{reportId}_report.json -o ~{Prefix} -s ~{Prefix}/results_summary.txt -p
    fi

    #Copy .ini file into final output directory
    cp -L -- "~{iniFile}" "~{Prefix}/djerba_input.ini"

    #Compress output dir
    tar -cvzf ~{Prefix}.tar.gz ~{Prefix}
```


